<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Example: option C in commercial buildings | Building energy statistical modelling</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Example: option C in commercial buildings | Building energy statistical modelling" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="github-repo" content="srouchier/buildingenergygeeks" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Example: option C in commercial buildings | Building energy statistical modelling" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Simon Rouchier" />


<meta name="date" content="2021-06-15" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="bayesian-mv.html"/>
<link rel="next" href="validation-and-results.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./index.html">Building energy statistical modelling</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Foreword</a></li>
<li class="part"><span><b>I Theory and workflow</b></span></li>
<li class="chapter" data-level="1" data-path="scope.html"><a href="scope.html"><i class="fa fa-check"></i><b>1</b> From data to energy savings</a></li>
<li class="chapter" data-level="2" data-path="models.html"><a href="models.html"><i class="fa fa-check"></i><b>2</b> Building energy statistical modelling</a></li>
<li class="chapter" data-level="3" data-path="workflow.html"><a href="workflow.html"><i class="fa fa-check"></i><b>3</b> A data analysis workflow</a></li>
<li class="part"><span><b>II Temporally independent data</b></span></li>
<li class="chapter" data-level="4" data-path="ordinary-linear-regression.html"><a href="ordinary-linear-regression.html"><i class="fa fa-check"></i><b>4</b> Ordinary linear regression</a><ul>
<li class="chapter" data-level="4.1" data-path="ordinary-linear-regression.html"><a href="ordinary-linear-regression.html#frequentist-olr"><i class="fa fa-check"></i><b>4.1</b> Frequentist OLR</a></li>
<li class="chapter" data-level="4.2" data-path="ordinary-linear-regression.html"><a href="ordinary-linear-regression.html#bayesian-olr"><i class="fa fa-check"></i><b>4.2</b> Bayesian OLR</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="bayesian-mv.html"><a href="bayesian-mv.html"><i class="fa fa-check"></i><b>5</b> Bayesian M&amp;V</a><ul>
<li class="chapter" data-level="5.1" data-path="bayesian-mv.html"><a href="bayesian-mv.html#how-it-works"><i class="fa fa-check"></i><b>5.1</b> How it works</a><ul>
<li class="chapter" data-level="5.1.1" data-path="bayesian-mv.html"><a href="bayesian-mv.html#step-1-setting-up-a-model"><i class="fa fa-check"></i><b>5.1.1</b> Step 1: setting up a model</a></li>
<li class="chapter" data-level="5.1.2" data-path="bayesian-mv.html"><a href="bayesian-mv.html#step-2-learning"><i class="fa fa-check"></i><b>5.1.2</b> Step 2: learning</a></li>
<li class="chapter" data-level="5.1.3" data-path="bayesian-mv.html"><a href="bayesian-mv.html#step-3-prediction-and-inference"><i class="fa fa-check"></i><b>5.1.3</b> Step 3: prediction and inference</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="bayesian-mv.html"><a href="bayesian-mv.html#about-this-document"><i class="fa fa-check"></i><b>5.2</b> About this document</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="example-option-c-in-commercial-buildings.html"><a href="example-option-c-in-commercial-buildings.html"><i class="fa fa-check"></i><b>6</b> Example: option C in commercial buildings</a><ul>
<li class="chapter" data-level="6.1" data-path="example-option-c-in-commercial-buildings.html"><a href="example-option-c-in-commercial-buildings.html#loading-and-displaying-the-data"><i class="fa fa-check"></i><b>6.1</b> Loading and displaying the data</a></li>
<li class="chapter" data-level="6.2" data-path="example-option-c-in-commercial-buildings.html"><a href="example-option-c-in-commercial-buildings.html#daily-averaged-data"><i class="fa fa-check"></i><b>6.2</b> Daily averaged data</a></li>
<li class="chapter" data-level="6.3" data-path="example-option-c-in-commercial-buildings.html"><a href="example-option-c-in-commercial-buildings.html#step-1-model-definition"><i class="fa fa-check"></i><b>6.3</b> Step 1: Model definition</a></li>
<li class="chapter" data-level="6.4" data-path="example-option-c-in-commercial-buildings.html"><a href="example-option-c-in-commercial-buildings.html#model-specification-with-stan"><i class="fa fa-check"></i><b>6.4</b> Model specification with STAN</a></li>
<li class="chapter" data-level="6.5" data-path="example-option-c-in-commercial-buildings.html"><a href="example-option-c-in-commercial-buildings.html#step-2-model-fitting"><i class="fa fa-check"></i><b>6.5</b> Step 2: Model fitting</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="validation-and-results.html"><a href="validation-and-results.html"><i class="fa fa-check"></i><b>7</b> Validation and results</a><ul>
<li class="chapter" data-level="7.1" data-path="validation-and-results.html"><a href="validation-and-results.html#parameters"><i class="fa fa-check"></i><b>7.1</b> Parameters</a></li>
<li class="chapter" data-level="7.2" data-path="validation-and-results.html"><a href="validation-and-results.html#predictions"><i class="fa fa-check"></i><b>7.2</b> Predictions</a></li>
<li class="chapter" data-level="7.3" data-path="validation-and-results.html"><a href="validation-and-results.html#residuals"><i class="fa fa-check"></i><b>7.3</b> Residuals</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="savings.html"><a href="savings.html"><i class="fa fa-check"></i><b>8</b> Savings</a></li>
<li class="chapter" data-level="9" data-path="finite-mixture-models.html"><a href="finite-mixture-models.html"><i class="fa fa-check"></i><b>9</b> Finite mixture models</a></li>
<li class="part"><span><b>III Time-series modelling</b></span></li>
<li class="chapter" data-level="10" data-path="autoregressive-models.html"><a href="autoregressive-models.html"><i class="fa fa-check"></i><b>10</b> Autoregressive models</a></li>
<li class="chapter" data-level="11" data-path="hidden-markov-models.html"><a href="hidden-markov-models.html"><i class="fa fa-check"></i><b>11</b> Hidden Markov models</a></li>
<li class="chapter" data-level="12" data-path="markov-switching-models.html"><a href="markov-switching-models.html"><i class="fa fa-check"></i><b>12</b> Markov switching models</a></li>
<li class="part"><span><b>IV State-space models</b></span></li>
<li class="chapter" data-level="13" data-path="the-most-simple-ssm.html"><a href="the-most-simple-ssm.html"><i class="fa fa-check"></i><b>13</b> The most simple SSM</a></li>
<li class="chapter" data-level="14" data-path="the-kalman-filter.html"><a href="the-kalman-filter.html"><i class="fa fa-check"></i><b>14</b> The Kalman filter</a></li>
<li class="chapter" data-level="15" data-path="the-pysip-library.html"><a href="the-pysip-library.html"><i class="fa fa-check"></i><b>15</b> The pySIP library</a></li>
<li class="part"><span><b>V Gaussian Process models</b></span></li>
<li class="chapter" data-level="16" data-path="gaussian-process-models.html"><a href="gaussian-process-models.html"><i class="fa fa-check"></i><b>16</b> Gaussian Process models</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Building energy statistical modelling</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="example-option-c-in-commercial-buildings" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> Example: option C in commercial buildings</h1>
<p>The data used in this example is the hourly energy consumption and outdoor air temperature data for 11 commercial buildings (office/retail), publicly available here:</p>
<p><a href="https://openei.org/datasets/dataset/consumption-outdoor-air-temperature-11-commercial-buildings" class="uri">https://openei.org/datasets/dataset/consumption-outdoor-air-temperature-11-commercial-buildings</a></p>
<p>We will be using two data files, respectively labeled <em>Building 6 (Office “Pre”)</em>, and <em>Building 6 (Office “Post”)</em>.</p>
<div id="loading-and-displaying-the-data" class="section level2">
<h2><span class="header-section-number">6.1</span> Loading and displaying the data</h2>
<p>The following block loads two separate data files:</p>
<ul>
<li><code>building60preoffice.csv</code> is the baseline period file, saved into the df.base variable</li>
<li><code>building60postoffice.csv</code> is the reporting period file, saved into the df.repo variable</li>
</ul>
<p>The <code>Date</code> column of both files is converted into a DateTime type into a new column. Then, the baseline dataset is displayed for a first exploratory look at the data.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="example-option-c-in-commercial-buildings.html#cb2-1"></a><span class="co"># Baseline data: one year</span></span>
<span id="cb2-2"><a href="example-option-c-in-commercial-buildings.html#cb2-2"></a>df.base &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/building60preoffice.csv&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-3"><a href="example-option-c-in-commercial-buildings.html#cb2-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">DateTime =</span> <span class="kw">mdy_hm</span>(Date),</span>
<span id="cb2-4"><a href="example-option-c-in-commercial-buildings.html#cb2-4"></a>         <span class="dt">Date =</span> <span class="kw">as_date</span>(DateTime))</span>
<span id="cb2-5"><a href="example-option-c-in-commercial-buildings.html#cb2-5"></a></span>
<span id="cb2-6"><a href="example-option-c-in-commercial-buildings.html#cb2-6"></a><span class="co"># Post-retrofit data: one year</span></span>
<span id="cb2-7"><a href="example-option-c-in-commercial-buildings.html#cb2-7"></a>df.repo &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/building62postoffice.csv&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-8"><a href="example-option-c-in-commercial-buildings.html#cb2-8"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">DateTime =</span> <span class="kw">mdy_hm</span>(Date),</span>
<span id="cb2-9"><a href="example-option-c-in-commercial-buildings.html#cb2-9"></a>         <span class="dt">Date =</span> <span class="kw">as_date</span>(DateTime))</span>
<span id="cb2-10"><a href="example-option-c-in-commercial-buildings.html#cb2-10"></a></span>
<span id="cb2-11"><a href="example-option-c-in-commercial-buildings.html#cb2-11"></a><span class="co"># Plot the original data</span></span>
<span id="cb2-12"><a href="example-option-c-in-commercial-buildings.html#cb2-12"></a><span class="kw">head</span>(df.base)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 4
##   Date         OAT `Building 6 kW` DateTime           
##   &lt;date&gt;     &lt;dbl&gt;           &lt;dbl&gt; &lt;dttm&gt;             
## 1 2009-01-02  41.6            23.3 2009-01-02 00:00:00
## 2 2009-01-02  40.9            23.1 2009-01-02 01:00:00
## 3 2009-01-02  39.5            23.7 2009-01-02 02:00:00
## 4 2009-01-02  36.3            29.1 2009-01-02 03:00:00
## 5 2009-01-02  32.8            35.6 2009-01-02 04:00:00
## 6 2009-01-02  32.5            45.5 2009-01-02 05:00:00</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="example-option-c-in-commercial-buildings.html#cb4-1"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> df.base) <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x=</span>DateTime, <span class="dt">y=</span><span class="st">`</span><span class="dt">Building 6 kW</span><span class="st">`</span>))</span></code></pre></div>
<p><img src="buildingenergygeeks_files/figure-html/unnamed-chunk-2-1.png" width="672" />
A few interesting observations:</p>
<ul>
<li>The data has a hourly time step size. Every hour, the outdoor air temperature (OAT in °F) and energy use (kW) are available.</li>
<li>The energy use is higher in summer and in winter than in-between. This suggests that this consumption data includes both heating and cooling appliances.</li>
<li>Week-ends are clearly visible with a lower consumption than in the working days of the week.</li>
</ul>
</div>
<div id="daily-averaged-data" class="section level2">
<h2><span class="header-section-number">6.2</span> Daily averaged data</h2>
<p>Averaging the data over daily time steps should allow to overlook the dependence between consecutive measurements. In turn, this allows using a model which will be much simpler than time series models, but will only be capable of low frequency predictions.</p>
<p>The following block creates new datasets from the original ones:</p>
<ul>
<li>Measurements are daily averaged</li>
<li>Temperatures are switched to °C for international suitability.</li>
<li>A categorical variable is added to indicate week ends.</li>
</ul>
<p>Then, we plot the daily energy use <span class="math inline">\(E\)</span> (kWh) versus the outdoor temperature <span class="math inline">\(T\)</span> (°C) for both values of the <code>week.end</code> categorical variable.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="example-option-c-in-commercial-buildings.html#cb5-1"></a>daily.average &lt;-<span class="st"> </span><span class="cf">function</span>(df) {</span>
<span id="cb5-2"><a href="example-option-c-in-commercial-buildings.html#cb5-2"></a>  df <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb5-3"><a href="example-option-c-in-commercial-buildings.html#cb5-3"></a><span class="st">    </span><span class="kw">group_by</span>(Date) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb5-4"><a href="example-option-c-in-commercial-buildings.html#cb5-4"></a><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">OAT =</span> <span class="kw">mean</span>(OAT),</span>
<span id="cb5-5"><a href="example-option-c-in-commercial-buildings.html#cb5-5"></a>              <span class="dt">E =</span> <span class="kw">sum</span>(<span class="st">`</span><span class="dt">Building 6 kW</span><span class="st">`</span>),</span>
<span id="cb5-6"><a href="example-option-c-in-commercial-buildings.html#cb5-6"></a>              <span class="dt">.groups =</span> <span class="st">&#39;drop&#39;</span></span>
<span id="cb5-7"><a href="example-option-c-in-commercial-buildings.html#cb5-7"></a>    ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb5-8"><a href="example-option-c-in-commercial-buildings.html#cb5-8"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">wday =</span> <span class="kw">wday</span>(Date),</span>
<span id="cb5-9"><a href="example-option-c-in-commercial-buildings.html#cb5-9"></a>           <span class="dt">week.end =</span> wday<span class="op">==</span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>wday<span class="op">==</span><span class="dv">7</span>,</span>
<span id="cb5-10"><a href="example-option-c-in-commercial-buildings.html#cb5-10"></a>           <span class="dt">T =</span> (OAT<span class="dv">-32</span>) <span class="op">*</span><span class="st"> </span><span class="dv">5</span><span class="op">/</span><span class="dv">9</span>)</span>
<span id="cb5-11"><a href="example-option-c-in-commercial-buildings.html#cb5-11"></a>}</span>
<span id="cb5-12"><a href="example-option-c-in-commercial-buildings.html#cb5-12"></a></span>
<span id="cb5-13"><a href="example-option-c-in-commercial-buildings.html#cb5-13"></a>df.base.daily &lt;-<span class="st"> </span><span class="kw">daily.average</span>(df.base)</span>
<span id="cb5-14"><a href="example-option-c-in-commercial-buildings.html#cb5-14"></a>df.repo.daily &lt;-<span class="st"> </span><span class="kw">daily.average</span>(df.repo)</span>
<span id="cb5-15"><a href="example-option-c-in-commercial-buildings.html#cb5-15"></a></span>
<span id="cb5-16"><a href="example-option-c-in-commercial-buildings.html#cb5-16"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> df.base.daily) <span class="op">+</span></span>
<span id="cb5-17"><a href="example-option-c-in-commercial-buildings.html#cb5-17"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x=</span>T, <span class="dt">y=</span>E, <span class="dt">color=</span>week.end))</span></code></pre></div>
<p><img src="buildingenergygeeks_files/figure-html/unnamed-chunk-3-1.png" width="672" />
# Modelling and training</p>
</div>
<div id="step-1-model-definition" class="section level2">
<h2><span class="header-section-number">6.3</span> Step 1: Model definition</h2>
<p>After looking at the data, we can suggest using a change-point model which will include the effects of heating and cooling, and separate week ends from working days. The expected daily energy use <span class="math inline">\(E\)</span> (in kWh per day) is a function of the outdoor temperature <span class="math inline">\(T\)</span> and of a number of parameters:</p>
<ul>
<li>For the week-ends: <span class="math inline">\(p(E|T) \sim \mathcal{N}\left[\alpha_1 + \beta_{1,h}(\tau_{1,h}-T)^+ + \beta_{1,c}(T-\tau_{1,c})^+, \sigma\right]\)</span></li>
<li>For the working days: <span class="math inline">\(p(E|T) \sim \mathcal{N}\left[\alpha_2 + \beta_{2,h}(\tau_{2,h}-T)^+ + \beta_{2,c}(T-\tau_{2,c})^+,\sigma\right]\)</span></li>
</ul>
<p>Where the 1 and 2 subscripts indicate week-ends and working day, respectively, and the <span class="math inline">\(h\)</span> and <span class="math inline">\(c\)</span> subscripts indicate heating and cooling modes. The <span class="math inline">\(+\)</span> superscript indicates that a term is only applied if above zero.</p>
<p>The two equations above mean that we expect the energy use <span class="math inline">\(E\)</span> to be a normal distribution centered around a change-point model, with a constant standard deviation <span class="math inline">\(\sigma\)</span>. Some particularities of Bayesian statistics are: this normal distribution can be replaced by any other probability distribution; the error term <span class="math inline">\(\sigma\)</span> can be formulated as a function of some inputs; etc.</p>
<p><strong>This model has 11 possible parameters</strong>, which makes it significantly more complex than an ordinary linear regression. We could simplify it by assuming that the “working days” and “week ends” mode share the same temperature thresholds for heating (<span class="math inline">\(\tau_{1,h}=\tau_{2,h}\)</span>) or for cooling (<span class="math inline">\(\tau_{1,c}=\tau_{2,c}\)</span>). The following method would also be exactly the same if we decided to complexify the model, for instance by assuming non-linear profiles on each side of the change points, or if we had more categorical variables.</p>
</div>
<div id="model-specification-with-stan" class="section level2">
<h2><span class="header-section-number">6.4</span> Model specification with STAN</h2>
<p>In this example, we use the STAN probabilistic programming language, which allows full Bayesian statistical inference.</p>
<p><a href="https://mc-stan.org/" class="uri">https://mc-stan.org/</a></p>
<p>A STAN model is a block of text which can either be written in a separate file, or in the same script as the current code. Specifying a model in STAN takes a certain learning curve, but it unlocks the full flexibility of Bayesian analysis.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="example-option-c-in-commercial-buildings.html#cb6-1"></a>changepoint &lt;-<span class="st"> &quot;</span></span>
<span id="cb6-2"><a href="example-option-c-in-commercial-buildings.html#cb6-2"></a><span class="st">functions {</span></span>
<span id="cb6-3"><a href="example-option-c-in-commercial-buildings.html#cb6-3"></a><span class="st">  // This chunk is the formula for the changepoint model which will be used several times in this program</span></span>
<span id="cb6-4"><a href="example-option-c-in-commercial-buildings.html#cb6-4"></a><span class="st">  real power_mean(int w, real t, vector alpha, vector beta_h, vector tau_h, vector beta_c, vector tau_c) {</span></span>
<span id="cb6-5"><a href="example-option-c-in-commercial-buildings.html#cb6-5"></a><span class="st">    real a = w ? alpha[1] : alpha[2];    // condition on the type of day</span></span>
<span id="cb6-6"><a href="example-option-c-in-commercial-buildings.html#cb6-6"></a><span class="st">    real heat = w ? beta_h[1] * fmax(tau_h[1]-t, 0) : beta_h[2] * fmax(tau_h[2]-t, 0) ;</span></span>
<span id="cb6-7"><a href="example-option-c-in-commercial-buildings.html#cb6-7"></a><span class="st">    real cool = w ? beta_c[1] * fmax(t-tau_c[1], 0) : beta_c[2] * fmax(t-tau_c[2], 0) ;</span></span>
<span id="cb6-8"><a href="example-option-c-in-commercial-buildings.html#cb6-8"></a><span class="st">    return (a + heat + cool);</span></span>
<span id="cb6-9"><a href="example-option-c-in-commercial-buildings.html#cb6-9"></a><span class="st">  }</span></span>
<span id="cb6-10"><a href="example-option-c-in-commercial-buildings.html#cb6-10"></a><span class="st">}</span></span>
<span id="cb6-11"><a href="example-option-c-in-commercial-buildings.html#cb6-11"></a><span class="st">data {</span></span>
<span id="cb6-12"><a href="example-option-c-in-commercial-buildings.html#cb6-12"></a><span class="st">  // This block declares all data which will be passed to the Stan model.</span></span>
<span id="cb6-13"><a href="example-option-c-in-commercial-buildings.html#cb6-13"></a><span class="st">  int&lt;lower=0&gt; N_base;        // number of data items in the baseline period</span></span>
<span id="cb6-14"><a href="example-option-c-in-commercial-buildings.html#cb6-14"></a><span class="st">  vector[N_base] t_base;      // temperature (baseline)</span></span>
<span id="cb6-15"><a href="example-option-c-in-commercial-buildings.html#cb6-15"></a><span class="st">  int w_base[N_base];      // categorical variable for the week ends (baseline)</span></span>
<span id="cb6-16"><a href="example-option-c-in-commercial-buildings.html#cb6-16"></a><span class="st">  vector[N_base] y_base;      // outcome energy vector (baseline)</span></span>
<span id="cb6-17"><a href="example-option-c-in-commercial-buildings.html#cb6-17"></a><span class="st">  </span></span>
<span id="cb6-18"><a href="example-option-c-in-commercial-buildings.html#cb6-18"></a><span class="st">  int&lt;lower=0&gt; N_repo;        // number of data items in the reporting period</span></span>
<span id="cb6-19"><a href="example-option-c-in-commercial-buildings.html#cb6-19"></a><span class="st">  vector[N_repo] t_repo;      // temperature (reporting)</span></span>
<span id="cb6-20"><a href="example-option-c-in-commercial-buildings.html#cb6-20"></a><span class="st">  int w_repo[N_repo];      // categorical variable for the week ends (reporting)</span></span>
<span id="cb6-21"><a href="example-option-c-in-commercial-buildings.html#cb6-21"></a><span class="st">  vector[N_repo] y_repo;      // outcome energy vector (reporting)</span></span>
<span id="cb6-22"><a href="example-option-c-in-commercial-buildings.html#cb6-22"></a><span class="st">}</span></span>
<span id="cb6-23"><a href="example-option-c-in-commercial-buildings.html#cb6-23"></a><span class="st">parameters {</span></span>
<span id="cb6-24"><a href="example-option-c-in-commercial-buildings.html#cb6-24"></a><span class="st">  // This block declares the parameters of the model. There are 10 parameters plus the error scale sigma</span></span>
<span id="cb6-25"><a href="example-option-c-in-commercial-buildings.html#cb6-25"></a><span class="st">  vector[2] alpha;      // baseline consumption (work days and week ends)</span></span>
<span id="cb6-26"><a href="example-option-c-in-commercial-buildings.html#cb6-26"></a><span class="st">  vector[2] beta_h;     // slopes for heating</span></span>
<span id="cb6-27"><a href="example-option-c-in-commercial-buildings.html#cb6-27"></a><span class="st">  vector[2] tau_h;      // threshold temperatures for heating</span></span>
<span id="cb6-28"><a href="example-option-c-in-commercial-buildings.html#cb6-28"></a><span class="st">  vector[2] beta_c;     // slopes for cooling</span></span>
<span id="cb6-29"><a href="example-option-c-in-commercial-buildings.html#cb6-29"></a><span class="st">  vector[2] tau_c;      // threshold temperatures for cooling</span></span>
<span id="cb6-30"><a href="example-option-c-in-commercial-buildings.html#cb6-30"></a><span class="st">  real&lt;lower=0&gt; sigma;  // error scale</span></span>
<span id="cb6-31"><a href="example-option-c-in-commercial-buildings.html#cb6-31"></a><span class="st">}</span></span>
<span id="cb6-32"><a href="example-option-c-in-commercial-buildings.html#cb6-32"></a><span class="st">model {</span></span>
<span id="cb6-33"><a href="example-option-c-in-commercial-buildings.html#cb6-33"></a><span class="st">  // Assigning prior distributions on some parameters</span></span>
<span id="cb6-34"><a href="example-option-c-in-commercial-buildings.html#cb6-34"></a><span class="st">  alpha ~ normal([400, 800], [150, 150]);</span></span>
<span id="cb6-35"><a href="example-option-c-in-commercial-buildings.html#cb6-35"></a><span class="st">  tau_h ~ normal(8, 5);</span></span>
<span id="cb6-36"><a href="example-option-c-in-commercial-buildings.html#cb6-36"></a><span class="st">  tau_c ~ normal(18, 5);</span></span>
<span id="cb6-37"><a href="example-option-c-in-commercial-buildings.html#cb6-37"></a><span class="st">  beta_h ~ normal(40, 15);</span></span>
<span id="cb6-38"><a href="example-option-c-in-commercial-buildings.html#cb6-38"></a><span class="st">  beta_c ~ normal(40, 15);</span></span>
<span id="cb6-39"><a href="example-option-c-in-commercial-buildings.html#cb6-39"></a><span class="st">  // Observational model</span></span>
<span id="cb6-40"><a href="example-option-c-in-commercial-buildings.html#cb6-40"></a><span class="st">  for (n in 1:N_base) {</span></span>
<span id="cb6-41"><a href="example-option-c-in-commercial-buildings.html#cb6-41"></a><span class="st">    y_base[n] ~ normal(power_mean(w_base[n], t_base[n], alpha, beta_h, tau_h, beta_c, tau_c), sigma);</span></span>
<span id="cb6-42"><a href="example-option-c-in-commercial-buildings.html#cb6-42"></a><span class="st">  }</span></span>
<span id="cb6-43"><a href="example-option-c-in-commercial-buildings.html#cb6-43"></a><span class="st">}</span></span>
<span id="cb6-44"><a href="example-option-c-in-commercial-buildings.html#cb6-44"></a><span class="st">generated quantities {</span></span>
<span id="cb6-45"><a href="example-option-c-in-commercial-buildings.html#cb6-45"></a><span class="st">  vector[N_base] y_base_pred;</span></span>
<span id="cb6-46"><a href="example-option-c-in-commercial-buildings.html#cb6-46"></a><span class="st">  vector[N_repo] y_repo_pred;</span></span>
<span id="cb6-47"><a href="example-option-c-in-commercial-buildings.html#cb6-47"></a><span class="st">  real savings = 0;</span></span>
<span id="cb6-48"><a href="example-option-c-in-commercial-buildings.html#cb6-48"></a><span class="st">  </span></span>
<span id="cb6-49"><a href="example-option-c-in-commercial-buildings.html#cb6-49"></a><span class="st">  for (n in 1:N_base) {</span></span>
<span id="cb6-50"><a href="example-option-c-in-commercial-buildings.html#cb6-50"></a><span class="st">    y_base_pred[n] = normal_rng(power_mean(w_base[n], t_base[n], alpha, beta_h, tau_h, beta_c, tau_c), sigma);</span></span>
<span id="cb6-51"><a href="example-option-c-in-commercial-buildings.html#cb6-51"></a><span class="st">  }</span></span>
<span id="cb6-52"><a href="example-option-c-in-commercial-buildings.html#cb6-52"></a><span class="st">  </span></span>
<span id="cb6-53"><a href="example-option-c-in-commercial-buildings.html#cb6-53"></a><span class="st">  for (n in 1:N_repo) {</span></span>
<span id="cb6-54"><a href="example-option-c-in-commercial-buildings.html#cb6-54"></a><span class="st">    y_repo_pred[n] = normal_rng(power_mean(w_repo[n], t_repo[n], alpha, beta_h, tau_h, beta_c, tau_c), sigma);</span></span>
<span id="cb6-55"><a href="example-option-c-in-commercial-buildings.html#cb6-55"></a><span class="st">    savings += y_repo_pred[n] - y_repo[n];</span></span>
<span id="cb6-56"><a href="example-option-c-in-commercial-buildings.html#cb6-56"></a><span class="st">  }</span></span>
<span id="cb6-57"><a href="example-option-c-in-commercial-buildings.html#cb6-57"></a><span class="st">}</span></span>
<span id="cb6-58"><a href="example-option-c-in-commercial-buildings.html#cb6-58"></a><span class="st">&quot;</span></span></code></pre></div>
<p>Then, a list called <code>model_data</code> is created, which maps each part of the data to its appropriate variable into the STAN model.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="example-option-c-in-commercial-buildings.html#cb7-1"></a>model_data &lt;-<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb7-2"><a href="example-option-c-in-commercial-buildings.html#cb7-2"></a>  <span class="dt">N_base =</span> <span class="kw">nrow</span>(df.base.daily),</span>
<span id="cb7-3"><a href="example-option-c-in-commercial-buildings.html#cb7-3"></a>  <span class="dt">t_base =</span> df.base.daily<span class="op">$</span>T,</span>
<span id="cb7-4"><a href="example-option-c-in-commercial-buildings.html#cb7-4"></a>  <span class="dt">w_base =</span> <span class="kw">as.numeric</span>(df.base.daily<span class="op">$</span>week.end),</span>
<span id="cb7-5"><a href="example-option-c-in-commercial-buildings.html#cb7-5"></a>  <span class="dt">y_base =</span> df.base.daily<span class="op">$</span>E,</span>
<span id="cb7-6"><a href="example-option-c-in-commercial-buildings.html#cb7-6"></a>  <span class="dt">N_repo =</span> <span class="kw">nrow</span>(df.repo.daily),</span>
<span id="cb7-7"><a href="example-option-c-in-commercial-buildings.html#cb7-7"></a>  <span class="dt">t_repo =</span> df.repo.daily<span class="op">$</span>T,</span>
<span id="cb7-8"><a href="example-option-c-in-commercial-buildings.html#cb7-8"></a>  <span class="dt">w_repo =</span> <span class="kw">as.numeric</span>(df.repo.daily<span class="op">$</span>week.end),</span>
<span id="cb7-9"><a href="example-option-c-in-commercial-buildings.html#cb7-9"></a>  <span class="dt">y_repo =</span> df.repo.daily<span class="op">$</span>E</span>
<span id="cb7-10"><a href="example-option-c-in-commercial-buildings.html#cb7-10"></a>)</span></code></pre></div>
</div>
<div id="step-2-model-fitting" class="section level2">
<h2><span class="header-section-number">6.5</span> Step 2: Model fitting</h2>
<p>Now that the model has been specified and the data has been mapped to its variables, the syntax for model fitting is below.</p>
<p>One disadvantage of Bayesian inference is that the MCMC algorithm takes much longer to converge than a typical least-squares model fitting method. Running the code below might take a minute because we are only using 365 data points, but the Bayesian approach might become problematic for larger data files (100,000 rows or more).</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="example-option-c-in-commercial-buildings.html#cb8-1"></a><span class="co"># Fitting the model</span></span>
<span id="cb8-2"><a href="example-option-c-in-commercial-buildings.html#cb8-2"></a>fit1 &lt;-<span class="st"> </span><span class="kw">stan</span>(</span>
<span id="cb8-3"><a href="example-option-c-in-commercial-buildings.html#cb8-3"></a>  <span class="dt">model_code =</span> changepoint,  <span class="co"># Stan program</span></span>
<span id="cb8-4"><a href="example-option-c-in-commercial-buildings.html#cb8-4"></a>  <span class="dt">data =</span> model_data,        <span class="co"># named list of data</span></span>
<span id="cb8-5"><a href="example-option-c-in-commercial-buildings.html#cb8-5"></a>  <span class="dt">chains =</span> <span class="dv">2</span>,               <span class="co"># number of Markov chains</span></span>
<span id="cb8-6"><a href="example-option-c-in-commercial-buildings.html#cb8-6"></a>  <span class="dt">warmup =</span> <span class="dv">1000</span>,            <span class="co"># number of warmup iterations per chain</span></span>
<span id="cb8-7"><a href="example-option-c-in-commercial-buildings.html#cb8-7"></a>  <span class="dt">iter =</span> <span class="dv">4000</span>,              <span class="co"># total number of iterations per chain</span></span>
<span id="cb8-8"><a href="example-option-c-in-commercial-buildings.html#cb8-8"></a>  <span class="dt">cores =</span> <span class="dv">2</span>,                <span class="co"># number of cores (could use one per chain)</span></span>
<span id="cb8-9"><a href="example-option-c-in-commercial-buildings.html#cb8-9"></a>  <span class="dt">refresh =</span> <span class="dv">0</span>,              <span class="co"># progress not shown</span></span>
<span id="cb8-10"><a href="example-option-c-in-commercial-buildings.html#cb8-10"></a>)</span></code></pre></div>
<p>Fitting may result in a number of warnings, telling us that some problems may have occurred: divergent transitions, large R-hat values, low Effective Sample Size… Obtaining a fit without these warnings takes some practice but is essential for an unbiased interpretation of the inferred variables and predictions. A guide to Stan’s warnings and how to address them is available here: <a href="https://mc-stan.org/misc/warnings.html" class="uri">https://mc-stan.org/misc/warnings.html</a></p>
<p>The first step into solving these warnings is to re-run the algorithm with different controls: <code>iter</code>, <code>max_treedepth</code>, etc. If problems persist, it is possible that the model is too complex for the information that the data is able to provide and should be simplified, or that stronger priors should be proposed. A lot of problems can be solved with some prior information. In our specific case, this is especially useful for the variables in the equation for the week-ends, since there are not a lot of data points.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="bayesian-mv.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="validation-and-results.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/B02-changepoint.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["buildingenergygeeks.pdf", "buildingenergygeeks.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
